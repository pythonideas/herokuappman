<style>
  .accounts {
    border-collapse: collapse;
    font-family: monospace;
    font-size: 20px;
  }
  .accounts td {
    border: solid 1px #777;
    padding: 3px;
    padding-left: 10px;
    padding-right: 10px;
  }
  .builds {
    border-collapse: collapse;
    font-family: monospace;
    font-size: 20px;
  }
  .builds td {
    border: solid 1px #777;
    padding: 3px;
    padding-left: 10px;
    padding-right: 10px;
  }
</style>

<script src="/vue.js"></script>
<script src="/utils.js"></script>

<div id="app">
  <div v-if="!params.appName">
    {{ welcome }}
    <hr />
    <button @click="setadminpass">Set Admin Pass</button>
    <hr />

    <table class="accounts">
      <tr v-for="account in appMan.accounts">
        <td style="font-weight: bold; color: #700; text-align: center">
          {{ account.name }}
        </td>
        <td style="font-weight: bold; color: #070; text-align: center">
          {{ Math.round((account.quotaTotal - account.quotaUsed)/3600) }}
        </td>
        <td>
          <table>
            <tr v-for="app in account.apps">
              <td
                style="
                  font-weight: bold;
                  color: #007;
                  min-width: 200px;
                  font-size: 18px;
                "
              >
                <a
                  rel="noopener noreferrer"
                  target="_blank"
                  :href="`https://${app.name}.herokuapp.com`"
                  >{{ app.name }}
                </a>
              </td>
              <td
                style="
                  font-weight: bold;
                  color: #700;
                  min-width: 30px;
                  text-align: center;
                  font-size: 18px;
                "
              >
                {{ Math.round(app.quotaUsed/3600) }}
              </td>
              <td
                style="
                  font-weight: bold;
                  color: #770;
                  min-width: 30px;
                  text-align: center;
                "
              >
                {{ app.region }}
              </td>
              <td style="">
                <button style="background-color: #afa" @click="getlogs(app)">
                  Logs
                </button>
                <button
                  style="background-color: #aff; margin-left: 10px"
                  @click="getbuilds(app)"
                >
                  Builds
                </button>
              </td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
  </div>
  <div v-if="params.builds">
    <span style="font-family: monospace">
      Builds of
      <span style="color: #070; font-weight: bold; font-size: 20px"
        >{{ params.appName }}</span
      >
    </span>
    <hr />
    <table class="builds">
      <tr v-for="build in params.builds">
        <td style="color: #007">{{ build.id }}</td>
        <td>{{build.created_at}}</td>
        <td
          :style="`font-weight:bold;${build.status === 'succeeded'?'color:#070;':'color:#700;'}`"
        >
          {{ build.status }}
        </td>
        <td>
          <a
            rel="noopener noreferrer"
            target="_blank"
            :href="build.output_stream_url"
            >Logs</a
          >
        </td>
      </tr>
    </table>
  </div>
</div>

<script>
  Vue.createApp({
    computed: {},
    methods: {
      getlogs(app) {
        post("getlogs", { app }).then((result) => {
          if (result.error) {
            window.alert(result.error);
          } else {
            window.open(result.logplex_url, "_blank");
          }
        });
      },
      getbuilds(app) {
        window.open(`?builds=${app.name}`, "_blank");
      },
      setadminpass() {
        const pass = window.prompt("Admin Pass");
        localStorage.setItem("ADMIN_PASS", pass);
        document.location.reload();
      },
    },
    data() {
      return {
        welcome: "Welcome to Heroku App Manager !",
        appMan: { accounts: [] },
        params: {},
      };
    },
    mounted() {
      const params = new URL(document.location).searchParams;

      const builds = params.get("builds");
      if (builds) {
        this.params.builds = [];

        this.params.appName = builds;

        post("getbuilds", { name: builds }).then((result) => {
          if (result.error) {
            window.alert(result.error);
          } else {
            this.params.builds = result;
          }
        });
      }
      post("appman", {}).then((result) => {
        if (result.error) {
          window.alert(result.error);
        } else {
          this.appMan = result;
        }
      });
    },
  }).mount("#app");

  hotReload();
</script>
